-- generated by a tool
SET search_path TO {{{escape_sql_keyword Namespace}}};

drop function if exists {{FunctionName}};

CREATE OR REPLACE FUNCTION {{FunctionName}} (
{{#each SelectInputFields}}
{{{escape_sql_keyword Name}}} {{ProviderTypeName}}{{#unless @last}},{{/unless}}
{{/each}}
) 
{{#if HasExcludedFields}}
RETURNS SETOF {{Name}}_result AS 
{{else}}
RETURNS SETOF {{{escape_sql_keyword Name}}} AS
{{/if}}
$$
    
    BEGIN
		
        IF (security_user_id_param is not null) THEN
		    perform set_config('app.user_id', security_user_id_param::text, true);
        END IF;

        RETURN QUERY
        SELECT
            {{#each Fields}}
            {{{escape_sql_keyword Parent.Name}}}.{{{escape_sql_keyword Name}}}{{#unless @last}},{{/unless}}
            {{/each}}
        FROM {{{escape_sql_keyword Name}}}
        WHERE 
        {{#each SelectFields}}
        {{{escape_sql_keyword Parent.Name}}}.{{{escape_sql_keyword Name}}} = {{escape_sql_keyword Parent.FunctionName}}.{{{escape_sql_keyword Name}}} {{#unless @last}}AND{{/unless}}{{#unless ../SoftDelete}};{{/unless}}
        {{/each}}
		{{#if SoftDelete}}
        AND deleted_date is NULL;
        {{/if}}		

    END
$$
  LANGUAGE plpgsql VOLATILE SECURITY INVOKER
  COST 100;

REVOKE ALL ON FUNCTION {{FunctionName}} ({{#each SelectInputFields}}{{ProviderTypeName}}{{#unless @last}},{{/unless}}{{/each}}) FROM public;

GRANT EXECUTE ON FUNCTION {{FunctionName}} ({{#each SelectInputFields}} {{ProviderTypeName}}{{#unless @last}},{{/unless}} {{/each}}) TO web_app_role;

COMMENT ON FUNCTION {{FunctionName}} ({{#each SelectInputFields}} {{ProviderTypeName}}{{#unless @last}},{{/unless}} {{/each}})
    IS '{"applicationtype":"{{Name}}", "generated":true {{#if ReturnsSingle}}, "single_result":true{{/if}} }';